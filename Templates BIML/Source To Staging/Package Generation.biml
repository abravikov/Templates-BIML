<Biml xmlns="http://schemas.varigence.com/biml.xsd">
<#@include file="Metadata Loading.biml"#>

<Connections>
    <OleDbConnection CreateInProject="true" Name="AdventureWorks2016" ConnectionString="Data Source=localhost;Initial Catalog=AdventureWorks2016;Integrated Security=SSPI;Provider=SQLNCLI11;" ></OleDbConnection>
    <OleDbConnection CreateInProject="true" Name="StagingAdventureWorks2016" ConnectionString="Data Source=localhost;Initial Catalog=StagingAdventureWorks2016;Integrated Security=SSPI;Provider=SQLNCLI11;" ></OleDbConnection>
</Connections>


<Packages>    
<#
    foreach (DataRow tableRow in tableList.Rows)
    {
        var packageName = tableRow["TABLE_SCHEMA"].ToString() +"_" + tableRow["TABLE_NAME"].ToString().Replace("[","").Replace("]","");
#>
    <Package Name="<#=packageName#>" ConstraintMode="Linear" ProtectionLevel="EncryptSensitiveWithUserKey">
        <Variables>
            
            <Variable Name="TableNameSource" DataType="String" EvaluateAsExpression="false"><#=tableRow["TABLE_SCHEMA"].ToString() +"." + tableRow["TABLE_NAME"].ToString()#></Variable>
            <Variable Name="TableNameTarget" DataType="String" EvaluateAsExpression="false"><#=tableRow["TABLE_SCHEMA"].ToString() +"." + tableRow["TABLE_NAME"].ToString()#></Variable>
            <Variable Name="SQL_truncate" DataType="String" EvaluateAsExpression="true">"truncate table " + @[User::TableNameTarget]</Variable>
        </Variables>
        <Tasks>
            <ExecuteSQL Name="<#="truncate Staging table" + packageName#>" ConnectionName="StagingAdventureWorks2016">
                <VariableInput VariableName="User.SQL_truncate"/>
            </ExecuteSQL>
            <Dataflow Name="Moving Data from Source to Staging">
                <Transformations>
                    <OleDbSource Name="Query Source" ConnectionName="AdventureWorks2016">
                        <TableFromVariableInput VariableName="User.TableNameSource"/>
                        
                    </OleDbSource>
                        <OleDbDestination Name="Feed Staging" ConnectionName="StagingAdventureWorks2016">
                            <TableFromVariableOutput VariableName="User.TableNameTarget"/>
                        </OleDbDestination>
                </Transformations>
            </Dataflow>
            
        </Tasks>
    </Package>
<#}#>
    
    <Package Name="_Master" ProtectionLevel="EncryptSensitiveWithUserKey">
        <Tasks>
            <#
                foreach (DataRow tableRow in tableList.Rows)
                {
                    var packageName = tableRow["TABLE_SCHEMA"].ToString() +"_" + tableRow["TABLE_NAME"].ToString().Replace("[","").Replace("]","");
            #>
               
                    <ExecutePackage Name="<#=packageName.Replace("."," ")#>">
                       
                       <ExternalProjectPackage Package="<#=packageName + ".dtsx"#>"/>
                    </ExecutePackage>
                    
                
                
            <#}#>
         </Tasks>
    </Package>
</Packages>
</Biml>